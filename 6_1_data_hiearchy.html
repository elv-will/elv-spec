<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Data Hiearchy and Key Prefixing</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="1_spaces.html"><strong aria-hidden="true">1.</strong> Spaces</a></li><li class="chapter-item expanded "><a href="2_providers.html"><strong aria-hidden="true">2.</strong> Providers</a></li><li class="chapter-item expanded "><a href="3_tenants.html"><strong aria-hidden="true">3.</strong> Tenants</a></li><li class="chapter-item expanded "><a href="4_libraries.html"><strong aria-hidden="true">4.</strong> Libraries</a></li><li class="chapter-item expanded "><a href="5_cobjs.html"><strong aria-hidden="true">5.</strong> Content Objects</a></li><li class="chapter-item expanded "><a href="6_kms.html"><strong aria-hidden="true">6.</strong> KMS</a></li><li class="chapter-item expanded "><a href="6_1_data_hiearchy.html" class="active"><strong aria-hidden="true">7.</strong> Data Hiearchy and Key Prefixing</a></li><li class="chapter-item expanded "><a href="7_part_networking.html"><strong aria-hidden="true">8.</strong> Part Networking</a></li><li class="chapter-item expanded "><a href="defs.html"><strong aria-hidden="true">9.</strong> Definitions</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="data-hierarchy-and-key-prefixing"><a class="header" href="#data-hierarchy-and-key-prefixing">Data Hierarchy and Key Prefixing</a></h1>
<p>Many of the entities in the system are scoped, meaning they only exist under another identity.
Individually, they have the following IDs:</p>
<table><thead><tr><th style="text-align: center">Entity</th><th>Identifier</th><th>Substrate Type</th></tr></thead><tbody>
<tr><td style="text-align: center">Provider</td><td><code>ProviderId</code></td><td>10-byte array</td></tr>
<tr><td style="text-align: center">Tenant</td><td><code>TenantId</code></td><td>10-byte array</td></tr>
<tr><td style="text-align: center">Node</td><td><code>NodeId</code></td><td>10-byte array</td></tr>
<tr><td style="text-align: center">Space</td><td><code>SpaceId</code></td><td>10-byte array</td></tr>
<tr><td style="text-align: center">Content Object</td><td><code>CobjId</code></td><td>10-byte array</td></tr>
<tr><td style="text-align: center">Content Object Version</td><td><code>CobjVersionId</code></td><td>32-byte array</td></tr>
<tr><td style="text-align: center">KMS</td><td><code>KMSId</code></td><td>10-byte array</td></tr>
<tr><td style="text-align: center">Library</td><td><code>LibraryId</code></td><td>unsigned 16-bit integer</td></tr>
</tbody></table>
<p>But they are hierarchical. </p>
<pre class="mermaid">flowchart TD
  space(Space)
  provider(Provider)
  node(Node)
  tenant(Tenant)
  kms(KMS)
  cobj(Content Object)
  lib(Library)
  cobjv(Content Object Version)

  space --&gt; provider
  space --&gt; tenant

  provider --&gt; node

  tenant --&gt; kms
  tenant --&gt; cobj
  tenant --&gt; lib
  cobj --&gt; cobjv
</pre>
<p>Providers and tenants exist within spaces, KMSs exist within a tenancy, etc.</p>
<h2 id="substrate--hierarchical-keys"><a class="header" href="#substrate--hierarchical-keys">Substrate &amp; Hierarchical keys</a></h2>
<p>In substrate, we have two different ways of expressing these sorts of has-many relationships.</p>
<h3 id="flat-ids-with-metadata"><a class="header" href="#flat-ids-with-metadata">Flat IDs with metadata</a></h3>
<p>We can either store the parent in some metadata key-value map associated with the child, like </p>
<pre><code>TenantId --&gt; TenantMetadata { space_id: SpaceId, ... }
</code></pre>
<p>In this case:</p>
<ul>
<li><code>TenantId</code>s are global: there's no way for the same <code>TenantId</code> to exist within multiple spaces. </li>
<li>In order to list all the tenants within a space, an indexer is required.</li>
<li>All you need to refer to a specific tenant is the <code>TenantId</code>, since the <code>SpaceId</code> is implied.</li>
<li>Deleting a space becomes complicated:
<ul>
<li>The total number of tenants must be stored on the space: <code>SpaceId --&gt; SpaceMetadata { tenant_count: u32 }</code></li>
<li>Each tenant must be manually deleted, and the <code>tenant_count</code> must be decremented on each delete</li>
<li>Once the <code>tenant_count</code> reaches 0, all other space-related storage can be deleted</li>
</ul>
</li>
</ul>
<h3 id="nested-ids"><a class="header" href="#nested-ids">Nested IDs</a></h3>
<p>Alternatively, we can choose to prefix the <code>TenantId</code> by the <code>SpaceId</code> anywhere that tenant data is stored, so we would get</p>
<pre><code>(SpaceId, TenantId) --&gt; TenantMetadata { ... }
</code></pre>
<p>In this case:</p>
<ul>
<li>To refer to a tenant, both the <code>SpaceId</code> and <code>TenantId</code> must be given, since the <code>TenantId</code> is not unique across spaces</li>
<li>Listing tenants is easy,</li>
<li>Deleting the parent entity becomes much easier: 
<ul>
<li>In order to delete a space, all the keys under <code>(SpaceId, TenantId)</code> must be deleted as well</li>
<li>On chain, we can do a key prefix delete which clears out all keys of the form <code>(SpaceId, ...)</code> (in RocksDb this sort of write is fast)</li>
</ul>
</li>
</ul>
<h2 id="current-architecture"><a class="header" href="#current-architecture">Current architecture</a></h2>
<p>It is annoying to refer to certain entities by both their id and their parents' ids, so in cases where deletion may not be so common (such as that for a space), flat ids are used.</p>
<p>Here is a complete list of how the IDs stored:</p>
<table><thead><tr><th style="text-align: center">Entity</th><th>Complete Id</th></tr></thead><tbody>
<tr><td style="text-align: center">Provider</td><td><code>ProviderId</code></td></tr>
<tr><td style="text-align: center">Tenant</td><td><code>TenantId</code></td></tr>
<tr><td style="text-align: center">Node</td><td><code>(ProviderId, NodeId)</code></td></tr>
<tr><td style="text-align: center">Space</td><td><code>SpaceId</code></td></tr>
<tr><td style="text-align: center">Content Object</td><td><code>(TenantId, ContentObjectId)</code></td></tr>
<tr><td style="text-align: center">Content Object Version</td><td><code>(TenantId, ContentObjectId, ContentObjectVersion)</code></td></tr>
<tr><td style="text-align: center">KMS</td><td><code>(TenantId, KMSId)</code></td></tr>
<tr><td style="text-align: center">Library</td><td><code>(TenantId, LibraryId)</code></td></tr>
</tbody></table>
<p>All provider and tenant children use nested IDs. 
Tenants and Providers use flat ids, since deleting a whole space should be considered very rare.
Tenants and providers may be often be deleted, however, for governance reasons. 
Some single blockchain call, then, needs to be able to delete an entire provider or entire tenancy.
To do this, the keys prefix deletes are needed to clean up their data.</p>
<h3 id="potential-alternative"><a class="header" href="#potential-alternative">Potential alternative</a></h3>
<p>An alternative is this: instead of doing some sort of hierarchical delete, governance could store a flag called <code>governance_delete</code>, stored in the metadata of a provider or tenant. 
Specific <code>governance_delete_*</code> methods could then exist on all children, who look up their parents, metadata, check that <code>governance_delete == true</code>, and delete the requested child.
This would allow for using a flat id with metadata, while still having governance be able to delete a child.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="6_kms.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="7_part_networking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="6_kms.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="7_part_networking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
    </body>
</html>
